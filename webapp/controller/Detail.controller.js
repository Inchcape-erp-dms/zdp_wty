sap.ui.define(["hicron/dp/wty/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/unified/FileUploaderParameter","sap/ui/core/Item","sap/ui/model/json/JSONModel","sap/m/UploadCollectionParameter","hicron/dp/wty/model/formatter","encollab/dp/controls/PartObjectNumber"],function(e,t,i,a,r,o,s,n,l,g,u){"use strict";return e.extend("hicron.dp.wty.controller.Detail",{formatter:g,_userAuthorisations:["WarrantyClaims"],_userParameters:["VKO"],_causalPart:null,_textMap:["customerComplaint","cause","correction","generalText"],onInit:function(){e.prototype.onInit.apply(this,arguments);this.setModel(new n({maxDate:new Date}),"viewModel");this.myRouter.getRoute("wtydetail").attachPatternMatched(this._onObjectMatched,this)},onAfterViewRendered:function(t){e.prototype.onAfterViewRendered.apply(this,arguments);window.document.title="Claim Enquiry"},_onObjectMatched:function(e){this.myView.setBusy(true);var t="/"+e.getParameter("arguments").wtyPath;try{this._causalPart=e.getParameter("arguments")["?params"].causalPart}catch(e){}var i=this.myView;this.myView.bindElement({path:t,parameters:{expand:"WtyItems,WtyHeaderAttachments,Forms,Contribution"},events:{dataRequested:function(){i.setBusy(true)},dataReceived:this._onDataReceived.bind(this),change:this._onBindingChange.bind(this)}});if(!this.mainModel.getData(t+"/WtyItems")){this.myView.getElementBinding().attachEventOnce("dataReceived",jQuery.proxy(function(){var e=this.mainModel.getData(t);if(!e){this.fireDetailNotFound()}else{this.fireDetailChanged(t)}},this))}else{this.fireDetailChanged(t)}var a=this;this.getView().getModel().read("/WtySymptomCategorySet",{success:function(e){a.getView().setModel(new n(e),"WtySymptomCateg");a.getView().getModel().read("/WtySymptomCodes",{success:function(e){a.getView().setModel(new n(e),"WtySymptomCodes")}})}});this.getView().getModel().read("/WtyTroubleCategorySet",{success:function(e){a.getView().setModel(new n(e),"WtyTroubleCategory");a.getView().getModel().read("/WtyTroubleCodes",{success:function(e){a.getView().setModel(new n(e),"WtyTroubleCodes")}})}})},_onDataReceived:function(e){this.getView().setBusy(false);if(!this.isUserAuthorised("WarrantyCreate"))return;var t=this.getModel("viewModel");var a=this.getView().getBindingContext().getObject();var r=this.getView().getBindingContext().getModel();var o=this.getView().getBindingContext().getObject().WtyItems.__list;var s={};t.setProperty("/SerialColumnVis",false);t.setProperty("/AttachmentNeeded",false);for(var n=0;n<o.length;n++){s=r.oData[o[n]];if(s.SerNumberReq==="X"){t.setProperty("/SerialColumnVis",true)}if(s.AttachReq==="X"){t.setProperty("/AttachmentNeeded",true)}}var l=this.getOwnerComponent().getMyDealers().filter(function(e){return e.Id===a.PartnerNr});if(l.length===0)return;t.setProperty("/isKmsAndDealerChangable",this._setFieldsChangable(a));t.setProperty("/refDateIsValid",true);if(a.ProcessingStatus===""||a.ProcessingStatus==="B001"||a.ProcessingStatus==="ZRTN"||a.ProcessingStatus==="ZRTR"){t.setProperty("/isSubmitable",true);t.setProperty("/isReadyToSubmit",this._checkIsReadyToSubmit());t.setProperty("/isDeleteable",true);if(this._wtyClaimsLockedMap[a.ClaimType]){t.setProperty("/isChangeable",!a.IsRecallBased);t.setProperty("/isTextsChangeable",!a.IsRecallBased);t.setProperty("/isGeneralTextChangeable",!a.IsRecallBased);t.setProperty("/isPWAAllowed",!a.IsRecallBased&&a.ClaimType!=="ZAUT"&&a.AuthorisationNr==="")}}if(a.ProcessingStatus==="ZRTR"){t.setProperty("/isAmendable",true)}if(a.ProcessingStatus==="ZCN1"){t.setProperty("/isZCN1",true)}if(a.ClaimType==="ZZSP"){if(a.ProcessingStatus==="B001"){t.setProperty("/isTextsChangeable",true);t.setProperty("/isGeneralTextChangeable",true)}}if(a.IsRecallBased===true){t.setProperty("/isGeneralTextChangeable",true)}if(a.ClaimType==="ZAUT"){t.setProperty("/showContributionTab",true);if(a.ProcessingStatus==="B006"){t.setProperty("/isPWACreateable",true)}}else{if(t.getProperty("/isSubmitable")&&a.ReferenceNr===""){i.show("Please enter Dealer RO")}}t.setProperty("/saveButtonTexts",t.getProperty("/isGeneralTextChangeable")||t.getProperty("/isTextsChangeable"));this.getView().byId("saveTextsButton").setEnabled(false).setType("Transparent")},_setFieldsChangable:function(e){if(e.ProcessingStatus===""||e.ProcessingStatus==="B001"||e.ProcessingStatus==="ZRTN"){return true}else return false},_onBindingChange:function(e){var t=this.getModel("viewModel");t.setProperty("/isAmendable",false);t.setProperty("/isChangeable",false);t.setProperty("/isTextsChangeable",false);t.setProperty("/isPWAAllowed",false);t.setProperty("/isPWACreateable",false);t.setProperty("/isSubmitable",false);t.setProperty("/isReadyToSubmit",false);t.setProperty("/isDeleteable",false);t.setProperty("/showContributionTab",false);t.setProperty("/showContributionError",false);t.setProperty("/isZCN1",false);t.setProperty("/isGeneralTextChangeable",false);t.setProperty("/saveButtonTexts",false);t.setProperty("/isKmsAndDealerChangable",false);this._onDataReceived()},_wtyClaimsLockedMap:{ZAUT:true,ZZCA:false,ZZCC:true,ZZCF:false,ZZEC:true,ZZEX:true,ZZFS:false,ZZGW:true,ZZIC:true,ZZNV:true,ZZPC:true,ZZPD:true,ZZPW:true,ZZSP:false,ZZWT:true,ZZEW:true,ZZBW:true,ZZUW:true},isChangeable:function(e){return this.getModel("viewModel").getProperty("/isChangeable")},onIconTabBarSelect:function(e){var t=e.getParameter("item");if(t.getId().indexOf("iconTabTexts")!=-1){this._checkInchcapeTexts()}},attachmentsVisible:function(e){return true},_checkIsReadyToSubmit:function(e){try{var t=this.getView().getBindingContext().getObject();if(t){if(t.ProcessingStatus===""||t.ProcessingStatus==="B001"||t.ProcessingStatus==="ZRTN"){if(this.myView.getBindingContext()){return this._checkDataComplete(e)}}}}catch(e){return false}},_checkLiveChangeSerial:function(e){this.myView.getModel("viewModel").setProperty("/isReadyToSubmit",this._checkIsReadyToSubmit(e))},fittedRRPFormatter:function(e,t){if(this.formatter.GreaterThan(e,t)){return"$"+this.formatter.currencyValue(e)}else{return"N/A"}},isReadyToCreate:function(e){if(!e)return false;if(this.myView.getBindingContext()){var t=this.myView.getBindingContext().getObject();return t?t.ClaimType==="ZAUT"&&t.ProcessingStatus==="B006":false}},_checkDataComplete:function(e){return this._checkHeader()&&this._checkItems()&&this._checkInchcapeTexts()&&this._checkContributions()&&this._checkAttachments()&&this._checkSerialFullfilled(e)},clearSerialNoPopup:function(){this._infoSerial=false;this.getModel("viewModel").setProperty("/serConfEnabl",false);this.getModel("viewModel").setProperty("/serialValueState",sap.ui.core.ValueState.None);this.getModel("viewModel").setProperty("/serialValueStateText","")},checkSerialNumber:function(e,i,a,r,o){var s=this.myView.getBindingContext().getObject();this._infoSerial=false;this.getModel("viewModel").setProperty("/serConfEnabl",false);this.getModel("recall").callFunction("/SerialNumberValidation",{method:"GET",urlParameters:{recallNumber:"",claimGUID:s.GUID,vehicleVIN:s.VIN,serialNumber:e,partNumber:i,causalPart:a,itemGUID:r},success:function(e){switch(e.Status){case"E":this._infoSerial=false;this._serialValidation=true;this.getModel("viewModel").setProperty("/serConfEnabl",false);this.getModel("viewModel").setProperty("/serialValueState",sap.ui.core.ValueState.Error);this.getModel("viewModel").setProperty("/serialValueStateText","Serial No. is not valid for a given part");break;case"I":this._infoSerial=true;this._serialValidation=true;this.getModel("viewModel").setProperty("/serConfEnabl",true);this.getModel("viewModel").setProperty("/serialValueState",sap.ui.core.ValueState.Warning);this.getModel("viewModel").setProperty("/serialValueStateText","Serial No. is related with different VIN");break;case"S":this._infoSerial=false;this._serialValidation=true;this.getModel("viewModel").setProperty("/serConfEnabl",true);this.getModel("viewModel").setProperty("/serialValueState",sap.ui.core.ValueState.Success);this.getModel("viewModel").setProperty("/serialValueStateText","");break;case"N":this._infoSerial=false;this._serialValidation=false;this.getModel("viewModel").setProperty("/serConfEnabl",true);this.getModel("viewModel").setProperty("/serialValueState",sap.ui.core.ValueState.None);this.getModel("viewModel").setProperty("/serialValueStateText","");break;default:this._infoSerial=false;this._serialValidation=false;this.getModel("viewModel").setProperty("/serConfEnabl",true);this.getModel("viewModel").setProperty("/serialValueState",sap.ui.core.ValueState.None);this.getModel("viewModel").setProperty("/serialValueStateText","");break}if(o&&this.getModel("viewModel").getProperty("/serConfEnabl")){this._findElementIn("serialConfirmButtonId",this._oDialog.findElements(true)).firePress()}}.bind(this),error:function(e){this._serialValidation=false;this.getModel("viewModel").setProperty("/serConfEnabl",true);t.alert(this.gatewayError(e),{icon:sap.m.MessageBox.Icon.ERROR,title:"Error"})}.bind(this)})},liveCheckSerialNumber:function(e){if(this._serialValidation){var t=e.getSource().getValue();var i=e.getSource().getBindingContext().getObject().Material;var a=e.getSource().getBindingContext().getObject().CausalPart;var r=e.getSource().getBindingContext().getObject().ItemGUID;this.checkSerialNumber(t,i,a,r)}},onEditSerial:function(e){this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("hicron.dp.wty.view.addSerialNumberDialog",this);this.myView.addDependent(this._oDialog);this._oDialog.bindElement({path:e.getSource().getBindingContext().getPath()});this.clearSerialNoPopup();var t=e.getSource().getBindingContext().getObject();this.checkSerialNumber(t.SerNumber,t.Material,t.CausalPart,t.ItemGUID);this.getModel("viewModel").setProperty("/serConfEnabl",false);this._oDialog.open()},onSerialConfirm:function(e){var t=e.getSource().getBindingContext().getPath();if(this._infoSerial){this.dialogWarningPopup(t)}else{this.serialConfirm(t)}},serialConfirm:function(e){var t=this._findElementIn("idSerialNumber",this._oDialog.findElements(true));this.onDialogCancel();this.busyDialog.open();this._performUpdate(e,{SerNumber:t.getValue()})},dialogWarningPopup:function(e){this._dialogWarning=sap.ui.xmlfragment("hicron.dp.wty.view.confirmWarningSerialDialog",this);this.myView.addDependent(this._dialogWarning);this._dialogWarning.bindElement({path:e});this._dialogWarning.open()},onWarningConfirm:function(e){this._warningConfirmed=true;this.onWarningCancel();this.serialConfirm(e.getSource().getBindingContext().getPath())},onWarningCancel:function(e){try{this._dialogWarning.close().destroy()}catch(e){}},_checkSerialFullfilled:function(e){var t=false;var i=this.myView.getBindingContext().getObject().WtyItems.__list;var a="";var r="";for(var o=0;o<this.myView.byId("wtyItems").getItems().length;o++){r=this.mainModel.getProperty("/"+i[o]).SerNumberReq;a=this.mainModel.getProperty("/"+i[o]).SerNumber;if(r==="X"&&a===""){t=true}}if(t){return false}return true},_checkHeader:function(){var e=this.myView.getBindingContext().getObject();return e.ClaimType==="ZAUT"||e.ReferenceNr.length>0},_checkItems:function(){var e=this.myView.getBindingContext().getObject();if(["ZZSP","ZZ1S"].indexOf(e.ClaimType)>=0)return true;var t=false;var i=false;for(var a=0,r,o=this.myView.byId("wtyItems").getItems();a<o.length;a++){r=o[a].getBindingContext().getObject();if(r.CausalPart==="X"){t=true}if(r.CausalLabor==="X"){i=true}}if(e.ClaimType==="ZZPC"){i=true}return t&&i},_checkInchcapeTexts:function(){var e=true;var t=this.getText("wtyTextErrorStateMessage");var i=this.myView.byId("iconTabTexts");if(this.isCustomerInchcape()){var a=this.myView.byId("customerComplaint");if(a.getValue()===""){e=false;a.setValueState("Error").setValueStateText(t)}else{a.setValueState("None").setValueStateText("")}var r=this.myView.byId("cause");if(r.getValue()===""){e=false;r.setValueState("Error").setValueStateText(t)}else{r.setValueState("None").setValueStateText("")}var o=this.myView.byId("correction");if(o.getValue()===""){e=false;o.setValueState("Error").setValueStateText(t)}else{o.setValueState("None").setValueStateText("")}if(this.myComponent.getMySetting("DP_COUNTRY").Value==="NZ"){if(this.getView().byId("idWtyAttachments").getItems().length>0){var s=this.myView.byId("generalText");if(s.getValue()===""){e=false;s.setValueState("Error").setValueStateText(t)}else{s.setValueState("None").setValueStateText("")}}}}if(e){i.setIconColor("Default")}else{i.setIconColor("Negative")}return e},_checkAttachments:function(){var e=this.getView().getBindingContext().getObject();var t=this.getModel("viewModel");if((e.ClaimType==="ZZPC"&&this.myComponent.getMySetting("DP_COUNTRY").Value==="NZ"||t.getProperty("/AttachmentNeeded")===true)&&this.getView().byId("idWtyAttachments").getItems().length===0){this.getView().byId("attachTab").setIconColor("Negative");return false}else{if(t.getProperty("/AttachmentNeeded")===true&&this.getView().byId("idWtyAttachments").getItems().length===0){return false}else{this.getView().byId("attachTab").setIconColor("Default");return true}}},itemTypeFormatter:function(e,t,i){if(t==="X"){return this.getText("wtyDetailCausalPart")}else{if(i==="X"){return this.getText("wtyDetailCausalLabour")}else{return e}}},fireDetailChanged:function(e){this.myView.setBusy(false)},fireDetailNotFound:function(){},onUpdateFinished:function(e){this.myView.setBusy(false);if(this.isChangeable("dummy")){var t=false;var i=false;for(var a=0,r,o=e.getSource().getItems();a<o.length;a++){r=o[a].getBindingContext().getObject();if(r.CausalPart==="X"){t=true}if(r.CausalLabor==="X"){i=true}}if(!t){if(this._causalPart){this._AddCausal(this._causalPart,"1")}else{this.addCausalPart(e)}}else{var s=this.myView.getBindingContext().getObject();if(s.ClaimType!=="ZZPC"&&!i){this.addCausalLabor(e)}else{this._onDataReceived()}}}this._setupContribModel()},_setupContribModel:function(){var e=this.myView.getBindingContext().getObject();if(e.ClaimType==="ZAUT"){var t=this.myView.getModel("contribModel");if(!t){t=new n;this.myView.setModel(t,"contribModel")}var i=this.getModel().getProperty(this.getView().getBindingContext().getPath()+"/Contribution");var a={Items:{Part:{id:"Part",label:"Parts",Distributor:Number(i.PartSubaruCont),Dealer:Number(i.PartDealerCont),Customer:Number(i.PartOwnerCont)},Labor:{id:"Labor",label:"Labour",Distributor:Number(i.LaborSubaruCont),Dealer:Number(i.LaborDealerCont),Customer:Number(i.LaborOwnerCont)},Sublet:{id:"Sublet",label:"Sublet",Distributor:Number(i.SubletSubaruCont),Dealer:Number(i.SubletDealerCont),Customer:Number(i.SubletOwnerCont)}},Contributions:i,Balanced:false};t.setData(a)}var r=this._checkDataComplete();this.getModel("viewModel").setProperty("/isReadyToSubmit",r)},contribTotalFormatter:function(e,t,i){return[Number(e)||0,Number(t)||0,Number(i)||0].reduce(function(e,t){return e+t},0)},contribValStateFormatter:function(e,t,i){var a=this.contribTotalFormatter(e,t,i);return a===100?"Success":"Error"},onContributionChange:function(e){e.getSource().setValue(parseInt(e.getParameter("newValue"),10).toString());var t=e.getSource().getBindingContext("contribModel").getObject();if(Number(t.Distributor)+Number(t.Dealer)+Number(t.Customer)===100){this._enableMyContribRow(e.getSource(),false);var i=this.getModel("contribModel").getData();var a=i.Contributions;a.LaborSubaruCont=i.Items.Labor.Distributor.toString();a.LaborDealerCont=i.Items.Labor.Dealer.toString();a.LaborOwnerCont=i.Items.Labor.Customer.toString();a.PartSubaruCont=i.Items.Part.Distributor.toString();a.PartDealerCont=i.Items.Part.Dealer.toString();a.PartOwnerCont=i.Items.Part.Customer.toString();a.SubletSubaruCont=i.Items.Sublet.Distributor.toString();a.SubletDealerCont=i.Items.Sublet.Dealer.toString();a.SubletOwnerCont=i.Items.Sublet.Customer.toString();var r="/WtyContributions(SalesOrg='"+a.SalesOrg+"',ClaimNr='"+a.ClaimNr+"',ClaimType='"+a.ClaimType+"',Version='"+a.Version+"')";var o=this._enableMyContribRow.bind(this,e.getSource(),true);this._performUpdate(r,a,o,null,true)}else{this._checkContributions()}},_checkContributions:function(){var e=true;if(this.getModel("contribModel")){var t=this.getModel("contribModel").getData();if(t&&t.Contributions.ClaimType==="ZAUT"){if(Number(t.Items.Labor.Distributor)+Number(t.Items.Labor.Dealer)+Number(t.Items.Labor.Customer)===100&&Number(t.Items.Part.Distributor)+Number(t.Items.Part.Dealer)+Number(t.Items.Part.Customer)===100&&Number(t.Items.Sublet.Distributor)+Number(t.Items.Sublet.Dealer)+Number(t.Items.Sublet.Customer)===100){}else{e=false}}}this.getModel("viewModel").setProperty("/showContributionError",!e);return e},_enableMyContribRow:function(e,t){var i=e.getParent().getCells();for(var a=0;a<i.length;a++){if(i[a].getValue){i[a].setEnabled(t)}}this.mainModel.refresh();this.busyDialog.close()},onExit:function(){if(this._oPopover){this._oPopover.destroy()}},_getHeaderPopover:function(){try{this._oPopover=sap.ui.xmlfragment("hicron.dp.wty.view.headerChangePopover",this)}catch(e){}return this._oPopover},handlePopoverConfirmButton:function(e){var t=this._oPopover.findElements(true);var i;var a={};this._addPayloadElement(a,"ReferenceDate");this._addPayloadElement(a,"ReferenceNr");this._addPayloadElement(a,"Mileage");this._addPayloadElement(a,"MileageUOM");this._addPayloadElement(a,"SymptomCode");this._addPayloadElement(a,"TroubleCode");if(this.partsInvoiceDateVisible(this.getView().getBindingContext().getObject().ClaimType)){this._addPayloadElement(a,"PartsInvoiceDate")}this._addPayloadElement(a,"LocationGridCode");this._addPayloadElement(a,"DiagnosisTroubleCode");a.ReferenceDateString=this.translateDateToStr(a.ReferenceDate);this._oPopover.close();this.onExit();this._performUpdate(e.getSource().getBindingContext().getPath(),a)},_addPayloadElement:function(e,t){var i="id"+t;var a=this._findElementIn(i,this._oPopover.findElements(true));if(a){try{e[t]=this.formatter.TZOffsetDate(a.getDateValue());e[t].setHours(12)}catch(i){if(a.getSelectedKey){e[t]=a.getSelectedKey()}if(typeof e[t]===undefined||e[t]===""){e[t]=a.getValue()}}}},handlePopoverCancelButton:function(e){this._oPopover.close()},onVINPressed:function(e){var t=this.getView().getBindingContext().getProperty("VIN"),i=sap.ushell.Container.getService("CrossApplicationNavigation"),a=i&&i.hrefForExternal({target:{semanticObject:"ZDPVehicles",action:"display"},params:{vin:t}})||"";i.toExternal({target:{shellHash:a}})},onTitleSelectorPress:function(e){var t=this._getHeaderPopover();this.myView.addDependent(t);t.setModel(this.getView().getModel());t.openBy(e.getParameter("domRef"));this._handleTrbCode(sap.ui.getCore().byId("idTroubleCode"));this._handleSympCode(sap.ui.getCore().byId("idSymptomCode"))},checkKms:function(e){var t=e.getSource();var i=this.formatter.isInteger(t.getValue());t.setValueState(i?"None":"Error")},isCustomerInchcape:function(e){return this.myComponent.Customer==="Inchcape"},onTextFieldLiveChange:function(e){this.getView().byId("saveTextsButton").setEnabled(true).setType("Reject");this.getModel("viewModel").setProperty("/isReadyToSubmit",false)},onTextFieldChange:function(e){var t=e.getSource();var i=t.getId().split("--")[1];this.mainModel.setProperty(this.getView().getBindingContext().getPath()+"/"+i.charAt(0).toUpperCase()+i.slice(1),e.getSource().getValue())},updateModelTexts:function(e){var t=this.getView().byId(e),i=t.getId().split("--")[1],a=t.getValue();this.mainModel.setProperty(this.getView().getBindingContext().getPath()+"/"+i.charAt(0).toUpperCase()+i.slice(1),a)},onSaveTexts:function(e){for(var t=0;t<this._textMap.length;t++){this.updateModelTexts(this._textMap[t])}this.getView().setBusy(true);var i=this;this.mainModel.submitChanges({success:function(e){i.mainModel.refresh(true);i.busyDialog.close()},error:function(e){this.busyDialog.close();this.gatewayError(e)}.bind(this)})},_submitChangesSuccess:function(e){},onItemPress:function(e){var t=e.getSource().getBindingContext().getObject();if(t){if(!this._oMaterialPopover){this._oMaterialPopover=sap.ui.xmlfragment("hicron.dp.wty.view.MaterialPopover",this);this.myView.addDependent(this._oMaterialPopover)}this._oMaterialPopover.bindElement({path:"/Materials('"+t.Material+"')",parameters:{expand:"MatPrices"}});this._oMaterialPopover.openBy(e.getSource())}},materialPopoverGo:function(e){this.materialPopoverClose();var t=e.getSource();if(t){var i=t.getBindingContext().getPath().substr(1),a=sap.ushell.Container.getService("CrossApplicationNavigation"),r=a&&a.hrefForExternal({target:{semanticObject:"ZDPParts",action:"display"},params:{parts:i}})||"";a.toExternal({target:{shellHash:r}})}},materialPopoverClose:function(e){this._oMaterialPopover.close()},onItemAdd:function(e){var t=this.getView().getBindingContext().getObject().ClaimType;if(t!=="ZZPC"){var i=e.getSource();if(!this._actionSheet){this._actionSheet=sap.ui.xmlfragment("hicron.dp.wty.view.addItemActionSheet",this);this.myView.addDependent(this._actionSheet)}this._actionSheet.openBy(i)}else{this.onItemAddMaterial(e)}},onDialogCancel:function(){try{this._oDialog.close().destroy()}catch(e){}},addCausalPart:function(e){this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("hicron.dp.wty.view.addCausalPartDialog",this);this._oDialog.bindElement({path:e.getSource().getBindingContext().getPath()});this.myView.addDependent(this._oDialog);this._oDialog.open()},addCausalLabor:function(e){this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("hicron.dp.wty.view.addCausalLaborDialog",this);this._oDialog.bindElement({path:e.getSource().getBindingContext().getPath()});this.myView.addDependent(this._oDialog);this._oDialog.open()},onItemAddMaterial:function(e){this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("encollab.dp.common.addMaterialDialog",this);this._oDialog.bindElement({path:e.getSource().getBindingContext().getPath()});this.myView.addDependent(this._oDialog);this._oDialog.open()},onAddMaterialSearch:function(e){var t=this._findElementIn("addMaterialList",this._oDialog.findElements(true));var i=[];var o=e.getSource().getValue();if(o&&o.length>3){i=[new a("MaterialDescUpper",r.Contains,o.toUpperCase()),new a("MaterialNr",r.Contains,o.toUpperCase())];t.bindItems({path:"/Materials",parameters:{select:"MaterialNr,MatlDesc"},template:sap.ui.xmlfragment("encollab.dp.common.addMaterialTemplate"),filters:[new a("SalesOrg",r.EQ,this.myComponent.getMySettingValue("VKO")),new a("MatlType",r.EQ,"HAWA"),new a(i,false)]})}},onAddLabourSearchRefresh:function(){var e=this.getView().byId("searchField");if(e.getValue){if(e.getValue.length>3)this.onAddLabourSearch()}},onAddLabourSearch:function(e){var t=this._findElementIn("addLabourList",this._oDialog.findElements(true));var i=[];var o=e.getSource().getValue();if(o&&o.length>3){i=[new a("FlatRateCodeName",r.Contains,o.toUpperCase()),new a("FlatRateCode",r.Contains,o.toUpperCase())];t.bindItems({path:"FlatRates",parameters:{select:"FlatRateCode,FlatRateCodeName"},template:sap.ui.xmlfragment("encollab.dp.common.addLabourTemplate"),filters:[new a(i,false)]})}},onAddSundrySearch:function(e){var t=this._findElementIn("addMaterialList",this._oDialog.findElements(true));var i=[];var o=e.getSource().getValue();if(o&&o.length>0){i=[new a("MaterialDescUpper",r.Contains,o.toUpperCase()),new a("MaterialNr",r.Contains,o.toUpperCase())];t.bindItems({path:"/Materials",parameters:{select:"MaterialNr,MatlDesc"},template:sap.ui.xmlfragment("encollab.dp.common.addMaterialTemplate"),filters:[new a("SalesOrg",r.EQ,this.myComponent.getMySettingValue("VKO")),new a("MatlType",r.EQ,"NLAG"),new a(i,false)]})}},_AddCausal:function(e,t){var i=this.getText("addCausalDialogSuccessMsg");var a=this.myView.getBindingContext().getObject();this.onDialogCancel();this.busyDialog.open();var r="1";if(a.ClaimType.substring(2,2)=="CF"||a.ClaimType.substring(2,2)=="SP"||a.ClaimType=="ZREC"||a.ClaimType=="ZCAM"||a.ClaimType=="ZZ1F"||a.ClaimType=="ZZPC"){r="0"}var o={VersionGUID:a.ICVersionGUID,Material:e,CausalPart:"X",ItemType:"MAT",Qty:t||r,UoM:"EA"};this._createItem(o,i)},onAddCausalSelect:function(e){var t;if(e.sId==="updateFinished"){if(e.getSource().getItems().length===1){t=e.getSource().getItems()[0]}else{return}}else{t=e.getParameter("listItem")}this._AddCausal(t.getDescription())},onAddCausalLabourSelect:function(e){var t;if(e.sId==="updateFinished"){if(e.getSource().getItems().length===1){t=e.getSource().getItems()[0]}else{return}}else{t=e.getParameter("listItem")}var i=this.getText("addWtyCausalLaborDialogSuccessMsg");var a=this.myView.getBindingContext().getObject();this.onDialogCancel();this.busyDialog.open();var r={VersionGUID:a.ICVersionGUID,Material:t.getDescription(),ItemType:"FR",Qty:"0",UoM:"EA",CausalLabor:"X"};this._createItem(r,i)},onAddMaterialSelect:function(e){var t;if(e.sId==="updateFinished"){if(e.getSource().getItems().length===1){t=e.getSource().getItems()[0]}else{return}}else{t=e.getParameter("listItem")}var i=this.getText("addMaterialDialogSuccessMsg");var a=this.myView.getBindingContext().getObject();this.onDialogCancel();this.busyDialog.open();var r={VersionGUID:a.ICVersionGUID,Material:t.getDescription(),ItemType:"MAT",Qty:"1",UoM:"EA"};this._createItem(r,i)},onItemAddSundry:function(e){this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("hicron.dp.wty.view.addSundryDialog",this);this._oDialog.bindElement({path:e.getSource().getBindingContext().getPath()});this.myView.addDependent(this._oDialog);this._oDialog.open()},onAddSundrySelect:function(e){var t;if(e.sId==="updateFinished"){if(e.getSource().getItems().length===1){t=e.getSource().getItems()[0]}else{return}}else{t=e.getParameter("listItem")}var i=this.getText("addMaterialDialogSuccessMsg");var a=this.myView.getBindingContext().getObject();this.onDialogCancel();this.busyDialog.open();var r={VersionGUID:a.ICVersionGUID,Material:t.getDescription(),ItemType:"ZSUN",Qty:"1"};var o=jQuery.proxy(function(e,t){this.busyDialog.close();var i="/WtyItems(guid'"+e.ItemGUID+"')";this._changeItemQtyDialog(i);this.warningMessage("Sundry Incomplete","The code for adding sundry items is not yet complete")},this);this._createItem(r,i,o)},_createItem:function(e,t,a){if(!a){a=jQuery.proxy(function(e,a){this.busyDialog.close();this.mainModel.refresh();i.show(t||"Success")},this)}this.resetMessagePopover();this.mainModel.create("/WtyItems",e,{success:a,error:jQuery.proxy(function(e){this.busyDialog.close();this.gatewayError(e)},this)})},onItemAddFlatRate:function(e){this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("hicron.dp.wty.view.addFlatrateDialog",this);this._oDialog.bindElement({path:e.getSource().getBindingContext().getPath()});this.myView.addDependent(this._oDialog);this._oDialog.open()},onFlatRateSelect:function(e){var t;if(e.sId==="updateFinished"){if(e.getSource().getItems().length===1){t=e.getSource().getItems()[0]}else{return}}else{t=e.getParameter("listItem")}var i=this.getText("addFlatrateDialogSuccessMsg");var a=this.myView.getBindingContext().getObject();this.onDialogCancel();this.busyDialog.open();var r={VersionGUID:a.ICVersionGUID,Material:t.getDescription(),ItemType:"FR",Qty:"1",UoM:"EA"};this._createItem(r,i)},onItemAddSublet:function(e){this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("hicron.dp.wty.view.addSubletDialog",this);this._oDialog.bindElement({path:e.getSource().getBindingContext().getPath()});this.myView.addDependent(this._oDialog);this.onSubletFieldChange();this._oDialog.open()},onSubletFieldChange:function(e){var t=true;var i=this._oDialog.findElements(true);var a=this._findElementIn("subletDesc",i);var r=this._findElementIn("subletValue",i);var o=this._findElementIn("subletUploader",i);var s=this._findElementIn("subletCodeCatalog",i);if(a.getValue().length>0){a.setValueState("Success")}else{a.setValueState("Error");t=false}if(s.getValue().length>0){s.setValueState("Success")}else{s.setValueState("Error");t=false}if(r.getValue().length>0){r.setValueState("Success")}else{r.setValueState("Error");t=false}if(o.getValue().length>0){o.setValueState("Success")}else{o.setValueState("Error");t=false}this._findElementIn("subletConfirmButton",this._oDialog.getButtons()).setEnabled(t)},onSubletConfirm:function(e){var t=this.getText("addSubletDialogSuccessMsg");var i=this._oDialog.findElements(true);var a=this._findElementIn("subletDesc",i);var r="1";var o=this._findElementIn("subletValue",i);var s=this.myView.getBindingContext().getObject();var n=this._findElementIn("subletCodeCatalog",i);this.busyDialog.open();var l={VersionGUID:s.ICVersionGUID,ClaimItemShortText:a.getValue(),ItemType:"SUBL",Qty:r,UoM:"EA",ValueIC:o.getValue(),ItemKey:n.getValue()};this._createItem(l,t,jQuery.proxy(this.uploadSubletAttachment,this))},handleValueHelp:function(e){var t=e.getSource().getValue();this.inputId=e.getSource().getId();if(!this._valueHelpDialog){this._valueHelpDialog=sap.ui.xmlfragment("hicron.dp.wty.view.subletCodeCatDialog",this);this.getView().addDependent(this._valueHelpDialog)}this._valueHelpDialog.getBinding("items").filter([new a("Katnr",r.Contains,t),new a("Ltext",r.Contains,t)]);this._valueHelpDialog.open(t)},_handleValueHelpSearchSubCat:function(e){var t=e.getParameter("value");var i=new a("Katnr",r.Contains,t);var o=new a("Ltext",r.Contains,t);e.getSource().getBinding("items").filter([i,o])},_handleValueHelpCloseSubCat:function(e){var t=e.getParameter("selectedItem");if(t){var i=sap.ui.getCore().byId(this.inputId),a=t.getTitle();i.setSelectedKey(a)}e.getSource().getBinding("items").filter([]);this.onSubletFieldChange()},uploadSubletAttachment:function(e,t){var i=this._oDialog.findElements(true);var a=this._findElementIn("subletDesc",i);var r=this._findElementIn("subletUploader",i);var s=r.getValue()+"|"+a.getValue();r.setUploadUrl("/sap/opu/odata/sap/ZDP151_WARRANTY_ENQUIRY_REDEF_SRV/WtyItems(guid'"+e.ItemGUID+"')/WtyItemAttachments");r.addHeaderParameter(new o({name:"Slug",value:s}));this.resetMessagePopover();this.mainModel.refreshSecurityToken(jQuery.proxy(function(e){var t=this.mainModel.getSecurityToken();e.addHeaderParameter(new o({name:"x-csrf-token",value:t}));e.upload()},this,r))},handleSubletUploadComplete:function(e){this.onDialogCancel();this.mainModel.refresh();this.busyDialog.close()},onItemDelete:function(e){this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("encollab.dp.common.itemDeleteDialog",this);this._oDialog.bindElement({path:e.getSource().getBindingContext().getPath()});this.myView.addDependent(this._oDialog);this._oDialog.open()},onDeleteDialogConfirm:function(e){var t=this.getText("deleteItemDialogSuccessMsg");var a=e.getSource().getBindingContext().getPath();this.onDialogCancel();this.busyDialog.open();this.resetMessagePopover();this.mainModel.remove(a,{success:jQuery.proxy(function(e,a){this.busyDialog.close();i.show(t);this.mainModel.refresh()},this),error:jQuery.proxy(function(e){this.busyDialog.close();this.gatewayError(e)},this)})},canChangeQty:function(e,t){var i=this.getView().getBindingContext().getObject();var a=this.getView().getModel().getProperty("/WtyItems(guid'"+e+"')");if(!i)return false;if(!e)return false;if(["B001","ZRTN"].indexOf(i.ProcessingStatus)>=0&&a.ItemType==="ZSUN"&&i.Plant==="6411")return true;return this.isChangeable()},canChangeValue:function(e,t){var i=this.getView().getBindingContext().getObject();var a=this.getView().getModel().getProperty("/WtyItems(guid'"+e+"')");if(!i)return false;if(!e)return false;if(["B001","ZRTN"].indexOf(i.ProcessingStatus)>=0&&a.ItemType==="ZSUN"&&i.Plant==="6411")return true;return t&&(a.ItemType==="SUBL"||a.ItemType==="ZSUN")},onChangeItemQty:function(e){var t=e.getSource().getBindingContext();var i=t.getObject();if(i.OpCodeEditable===false&&(i.ItemType!=="MAT"&&i.ItemType!=="ZSUN")||i.CausalPart==="X"){this._performUpdate(t.getPath(),{Qty:i.Qty==="0.000"?"1":"0"})}else{if(i.UoM==="H"){this._changeItemHoursDialog(t.getPath())}else{this._changeItemQtyDialog(t.getPath())}}},_changeItemQtyDialog:function(e){this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("hicron.dp.wty.view.changeQtyDialog",this);this._oDialog.bindElement({path:e});this.myView.addDependent(this._oDialog);this._oDialog.open()},_changeItemHoursDialog:function(e){this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("hicron.dp.wty.view.changeHoursDialog",this);this._oDialog.bindElement({path:e});this.myView.addDependent(this._oDialog);this._oDialog.open()},Hours:function(e){var t=new Date(e*3600*1e3);return("0"+t.getUTCHours()).slice(-2)+":"+("0"+t.getUTCMinutes()).slice(-2)},onQtyLiveChange:function(e){var t=this._findElementIn("confirmButton",this._oDialog.getButtons());if(e.getParameter("newValue")>0){t.setEnabled(true);e.getSource().removeStyleClass("qtyError")}else{t.setEnabled(false);e.getSource().addStyleClass("qtyError")}},onQtyDialogConfirm:function(e){var t=this._findElementIn("newQty",this._oDialog.findElements(true));var i=e.getSource().getBindingContext().getPath();this.onDialogCancel();this._performUpdate(i,{Qty:t.getValue()})},onHoursDialogConfirm:function(e){var t=this._findElementIn("newHours",this._oDialog.findElements(true));var i=t.getValue();this.onDialogCancel();this._performUpdate(e.getSource().getBindingContext().getPath(),{Qty:String(i)})},HoursNew:function(e){return parseFloat(e).toFixed(2)},onChangeItemValue:function(e){this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("hicron.dp.wty.view.changeValueDialog",this);this._oDialog.bindElement({path:e.getSource().getBindingContext().getPath()});this.myView.addDependent(this._oDialog);this._oDialog.open()},onValueLiveChange:function(e){var t=this._findElementIn("confirmButton",this._oDialog.getButtons());if(e.getParameter("newValue")>0){t.setEnabled(true);e.getSource().removeStyleClass("qtyError")}else{t.setEnabled(false);e.getSource().addStyleClass("qtyError")}},onValueDialogConfirm:function(e){var t=this._findElementIn("newValue",this._oDialog.findElements(true));var i=e.getSource().getBindingContext().getPath();this.onDialogCancel();this.busyDialog.open();this._performUpdate(i,{ValueIC:t.getValue()})},checkSublets:function(e){var t=this.getView().getBindingContext().getModel();var i=this.getView().getBindingContext().getObject().WtyItems.__list;var a={};var r=0;for(var o=0;o<i.length;o++){a=t.oData[i[o]];if(a.ControllingItemType==="SUBL")r++}if(this.getView().byId("idWtyAttachments").getItems().length<r)return false;else return true},messageBoxPopupError:function(){var e=!!this.getView().$().closest(".sapUiSizeCompact").length;t.error("Add proper attachments to all Sublets!",{styleClass:e?"sapUiSizeCompact":""});this.getView().byId("attachTab").setIconColor("Critical")},onClaimSubmit:function(e){var t=this.checkSublets(e);if(!t){this.messageBoxPopupError();return}this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("hicron.dp.wty.view.claimSubmitDialog",this);this._oDialog.bindElement({path:e.getSource().getBindingContext().getPath()});this.myView.addDependent(this._oDialog);this._oDialog.open()},onSubmitClaimDialogConfirm:function(e){this.onDialogCancel();this.busyDialog.open();var t=this.mainModel.bUseBatch;this.mainModel.setUseBatch(true);if(this.mainModel.hasPendingChanges()){this.mainModel.submitChanges({success:jQuery.proxy(function(e){var i=e.__batchResponses[0].response;this.mainModel.setUseBatch(t);if(typeof i!=="undefined"&&(i.statusCode==="400"||i.statusCode==="500")){this.busyDialog.close();this.gatewayError(i,true);return}this._performAction("ZSB2",this.getText("submitWtyDialogSuccessMsg"))},this),error:function(e){this.mainModel.setUseBatch(t);this.busyDialog.close();this.gatewayError(e)}.bind(this)})}else{this.mainModel.setUseBatch(t);this._performAction("ZSB2",this.getText("submitWtyDialogSuccessMsg"))}},onPartsSent:function(e){this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("hicron.dp.wty.view.partsSentDialog",this);this._oDialog.bindElement({path:e.getSource().getBindingContext().getPath()});this.myView.addDependent(this._oDialog);this._oDialog.open()},onPartsSentDialogConfirm:function(e){this._performAction("ZCN2")},onClaimAmend:function(e){this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("hicron.dp.wty.view.claimAmendDialog",this);this._oDialog.bindElement({path:e.getSource().getBindingContext().getPath()});this.myView.addDependent(this._oDialog);this._oDialog.open()},onAmendClaimDialogConfirm:function(e){this._performAction("ZRTN",this.getText("amendWtyDialogSuccessMsg"))},_performAction:function(e,t,a,r){if(!t){t=this.getText("successMsg")}if(!a){a=function(e,a){i.show(t);this.busyDialog.close();location.reload()}}if(!r){r=function(e){this.gatewayError(e);this.busyDialog.close()}}this.busyDialog.open();this.onDialogCancel();var o=this.myView.getBindingContext().getObject();var s={WtyAction:e,WtyClaimNumber:o.ClaimNr};this.resetMessagePopover();this.mainModel.callFunction("/WtyClaimAction",{method:"POST",urlParameters:s,success:a.bind(this),error:r.bind(this)})},onClaimCreate:function(e){this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("hicron.dp.wty.view.createFromPWADialog",this);this._oDialog.bindElement({path:e.getSource().getBindingContext().getPath()});this.myView.addDependent(this._oDialog);var t=this._findElementIn("claimTypeSelect",this._oDialog.findElements(true));var i=new s({key:"{PWACategory}",text:"{PWACategory}-{PWACategoryDesc}"});t.bindAggregation("items",{path:"PWAClaimTypes",template:i});this._oDialog.open()},onClaimCreateSelect:function(e){var t=this.getText("createFromPWADialogSuccessMsg");var a=this._findElementIn("claimTypeSelect",this._oDialog.findElements(true));var r=this.myView.getBindingContext().getObject();this.onDialogCancel();var o={WtyClaimNumber:r.ClaimNr,WtyClaimType:a.getSelectedKey()};this.resetMessagePopover();this.mainModel.callFunction("/WtyClaimCopy",{method:"GET",urlParameters:o,success:$.proxy(function(e,a){i.show(t);this.busyDialog.close();this.myRouter.navTo("wtydetail",{wtyPath:"WtyHeaders(guid'"+e.results[0].GUID+"')"})},this),error:$.proxy(function(e){this.gatewayError(e)},this)})},onPWACreate:function(e){this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("hicron.dp.wty.view.pwaCreateDialog",this);this._oDialog.bindElement({path:e.getSource().getBindingContext().getPath()});this.myView.addDependent(this._oDialog);this._oDialog.open()},onPwaCreateDialogConfirm:function(e){var t=function(e,t){i.show(this.getText("deleteWtyDialogSuccessMsg"));this.busyDialog.close();this.myRouter.navTo("wtydetail",{wtyPath:"WtyHeaders(guid'"+e.GUID+"')"})};this._performAction("ZC2P",null,t)},onClaimDelete:function(e){this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("hicron.dp.wty.view.claimDeleteDialog",this);this._oDialog.bindElement({path:e.getSource().getBindingContext().getPath()});this.myView.addDependent(this._oDialog);this._oDialog.open()},onDeleteOrderDialogConfirm:function(e){this._performAction("ZCNC",this.getText("deleteWtyDialogSuccessMsg"))},onAttachUploadChange:function(e){var i=this.mainModel.getSecurityToken();var a=e.getSource();var r=e.getParameter("files")[0].name;if(e.getParameter("files")[0].size>10*1048576){var o=!!this.getView().$().closest(".sapUiSizeCompact").length;t.error("File size is greater than 10MB. Upload process has been cancelled!",{styleClass:o?"sapUiSizeCompact":""});return}a.removeAllHeaderParameters();a.insertHeaderParameter(new l({name:"x-csrf-token",value:i}));a.insertHeaderParameter(new l({name:"Slug",value:r}));this.mainModel.refresh()},onAttachDelete:function(e){var t=e.getParameter("item").getBindingContext().getPath();var i=this.mainModel;this.busyDialog.open();this.resetMessagePopover();i.remove(t,{success:jQuery.proxy(function(e,t){this.busyDialog.close();i.refresh()},this),error:jQuery.proxy(function(e){this.busyDialog.close();this.gatewayError(e)},this)});var a=this._checkDataComplete();this.getModel("viewModel").setProperty("/isReadyToSubmit",a);this.mainModel.refresh()},onAttachUploadComplete:function(e){this.getView().byId("attachTab").setIconColor("Default");this.mainModel.refresh()},headerUrl:function(e){return this.mainModel.sServiceUrl+"/WtyHeaders(guid'"+e+"')"},onPartsReturnPress:function(e){this.getView().setModel(new n,"consign");this._initializeConsignment();this.onDialogCancel();this._oDialog=sap.ui.xmlfragment("hicron.dp.wty.view.addConsignment",this);this._oDialog.bindElement({path:e.getSource().getBindingContext().getPath()});this._oDialog.bindElement({model:"consign",path:"/"});this.myView.addDependent(this._oDialog);this._oDialog.open()},onConsChange:function(e){var t=e.getSource().getBindingContext("consign").getObject();if(t.ConsignmentNote.length>0&&Number(t.NofCartons)>0&&Number(t.GrossWeight)>0&&t.Dimensions.length>0&&t.FreightProvider.length>0){t.ReadyToSubmit=true}else{t.ReadyToSubmit=false}},onConsignmentCreate:function(e){var t=e.getSource().getBindingContext("consign").getObject();var i={Clmno:this.getView().getBindingContext().getObject().ClaimNr,ConsignmentNote:t.ConsignmentNote,NofCartons:t.NofCartons,GrossWeight:t.GrossWeight,Dimensions:t.Dimensions,FreightProvider:t.FreightProvider};this._oDialog.close();this.busyDialog.open();this.resetMessagePopover();this.mainModel.create("/WtyConsignments",i,{success:jQuery.proxy(function(e,t){this.mainModel.refresh();this.busyDialog.close()},this),error:jQuery.proxy(function(e){this.busyDialog.close();this.gatewayError(e)},this)})},_initializeConsignment:function(){this.getView().getModel("consign").setData({Clmno:this.getView().getBindingContext().getObject().ClaimNr,ConsignmentNote:"Test",NofCartons:"",GrossWeight:"",Dimensions:"",FreightProvider:"",Material:"",ReadyToSubmit:false})},partsInvoiceDateVisible:function(e){if(this.myComponent.Customer==="Inchcape"){var t=[];t.ZAUT=true;t.ZZPW=true;t.ZZPC=true;return t[e]===true}else{return false}},_performUpdate:function(e,t,i,a,r){if(!r)this.busyDialog.open();if(!i){i=jQuery.proxy(function(e,t){this.mainModel.refresh();this.busyDialog.close()},this)}if(!a){a=jQuery.proxy(function(e){this.busyDialog.close();this.gatewayError(e)},this)}this.resetMessagePopover();this.mainModel.update(e,t,{merge:true,success:i,error:a})},formURL:function(e,t){return this.getModel().sServiceUrl+"/WtyForms(ClaimNr='"+e+"',ObjType='"+t+"')/Print/$value"},onNavBack:function(){e.prototype.onNavBack.apply(this,["wty"])},MileageRefresh:function(e){var t=this.getView().mAggregations.dependents[0];var i=t.getModel();i.refresh(true)},isValidDate:function(e){var t="None";var i=this.getModel("viewModel");if(e===null){i.setProperty("/refDateIsValid",false);t="Error"}if(e>(new Date).setHours(12)){t="Error";i.setProperty("/refDateIsValid",false)}return t},onRefDateChange:function(e){if(this.simplyCheckRepairDate(e)==false){return}this.checkWarrantyValidity(e)},simplyCheckRepairDate:function(e){var t=new Date,i=new Date(e.getSource().getDateValue());var a=this.getModel("viewModel");var r=this._oPopover.findElements(true);if(i>t){var o=this._findElementIn("idHandlePopoverConfirmBtn",r);o.setEnabled(false);var s=this._findElementIn("idReferenceDate",r);s.setValueState("Error");a.setProperty("/refDateIsValid",false);return false}else{var o=this._findElementIn("idHandlePopoverConfirmBtn",r);o.setEnabled(true);var s=this._findElementIn("idReferenceDate",r);s.setValueState("None");a.setProperty("/refDateIsValid",true);return true}},translateDateToStr:function(e){var t=e.getDate().toString().length==1?"0"+e.getDate().toString():e.getDate().toString();var i=(e.getMonth()+1).toString().length==1?"0"+(e.getMonth()+1).toString():(e.getMonth()+1).toString();return e.getFullYear().toString()+i+t},checkWarrantyValidity:function(e){var i=this.getModel().getProperty(this.getView().getBindingContext().getPath());var a=i.VIN;var r=i.ClaimType;var o=e.getSource().getDateValue();var s=new Date(o);var n=this.translateDateToStr(o);var l=e.getSource();var g=this;var u="None";this.bWarrantyValid=false;var h=this.getModel("viewModel");h.setProperty("/refDateIsValid",false);this.getModel().callFunction("/CheckWarrantyValidity",{method:"GET",urlParameters:{VIN:a,ClaimType:r,RepairDate:s,RepairDateStr:n,Mileage:0},success:$.proxy(function(e,t){if(e.NotValid==="X"){var i=s.toLocaleDateString();g.popErrorMessage(g.getText("wtyValidityErrorTitle"),g.getText("wtyWarrantyValidityError",[e.GaartTxt,i]));u="Error";l.setValueState(u);h.setProperty("/refDateIsValid",false)}else{if(s>new Date){u="Error";h.setProperty("/refDateIsValid",false)}else{u="None";h.setProperty("/refDateIsValid",true)}l.setValueState(u)}}),error:$.proxy(function(e){t.alert(this.gatewayError(e));u="Error";h.setProperty("/refDateIsValid",false);l.setValueState(u)},this)})},onSymTrbCategoryChange:function(e){if($.inArray(e.getSource().getId(),["idSymptomCategory","idTroubleCategory"])>-1){this._handleSymTrbCategory(e.getSource())}else if(e.getSource().getId()==="idTroubleCode"){this._handleTrbCode(e.getSource())}else if(e.getSource().getId()==="idSymptomCode"){this._handleSympCode(e.getSource())}}})});
//# sourceMappingURL=Detail.controller.js.map