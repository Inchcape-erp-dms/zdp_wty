sap.ui.define(["hicron/dp/wty/controller/BaseController","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/ui/core/Item","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/odata/v2/ODataModel","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,i,a,r,s,n,l,o){"use strict";return e.extend("hicron.dp.wty.controller.Create",{_userAuthorisations:["WarrantyClaims","WarrantyCreate"],_partsClaim:false,_oStep1Validated:false,_oStep2Validated:false,_oStep3Validated:false,onInit:function(){e.prototype.onInit.apply(this,arguments);this.bWarrantyValid=false;this._Customer=this.myComponent.Customer;this.getView().setModel(new i,"newClaim");this.getView().setModel(new i,"it");this.myRouter.getRoute("createwty").attachPatternMatched(this._onVehicleMatched,this);this.myRouter.getRoute("createwtypart").attachPatternMatched(this._onPartMatched,this)},onAfterViewRendered:function(t){e.prototype.onAfterViewRendered.apply(this,arguments);window.document.title="Create Claim";var i=this.getModel("core").getProperty("/Users('"+this.getOwnerComponent().getMyId()+"')/Dealers");if(!i||!i.length||i.length===0){this.popErrorMessage("No Dealer","This user not linked to a dealer");this.getView().getContent()[0].destroyContent()}},_onVehicleMatched:function(e){this._partsClaim=false;var t="/"+e.getParameter("arguments").vehiclePath;this._vehiclePath=t;this.getView().bindElement({model:"vin",path:t});this.VIN=t.match(/'.*'/)[0].replace(/'/g,"");this.getView().setBusy(true);this._buildWizard();this.getView().byId("createClaimPage").setTitle(this.getText("wtyClaimCreateTitle",t.match(/'.*'/)));this._getTroubleCatAndSymptomCat()},_getTroubleCatAndSymptomCat:function(){var e=this;this.getView().getModel().read("/WtySymptomCategorySet",{success:function(t){e.getView().setModel(new i(t),"WtySymptomCateg");e.getView().getModel().read("/WtySymptomCodes",{success:function(t){e.getView().setModel(new i(t),"WtySymptomCodes")}})}});this.getView().getModel().read("/WtyTroubleCategorySet",{success:function(t){e.getView().setModel(new i(t),"WtyTroubleCategory");e.getView().getModel().read("/WtyTroubleCodes",{success:function(t){e.getView().setModel(new i(t),"WtyTroubleCodes")}})}})},_onPartMatched:function(e){this._partsClaim=true;var t="/"+e.getParameter("arguments").partPath;this.getView().bindElement({path:t});this.getView().setBusy(true);this._buildWizard();this.getView().byId("createClaimPage").setTitle(this.getText("wtyClaimCreateTitle",t.match(/'.*'/)));this.getModel("newClaim").setProperty("/ViewData/partsClaim",true);this._getTroubleCatAndSymptomCat()},_buildWizard:function(){this.initializeNewClaimData();var e=this.getView().byId("createClaimPage");if(this._wizard){try{this._wizard.destroy()}catch(e){}}if(this._Customer==="Inchcape"){this._wizard=sap.ui.xmlfragment("hicron.dp.wty.view.wizard",this);e.addContent(this._wizard)}else{this._wizard=sap.ui.xmlfragment("hicron.dp.wty.view.standardForm",this);e.addContent(this._wizard);this.getView().byId("onSaveButton").setVisible(true)}this._getClaimTypes();if(!this._partsClaim){this.getView().getModel("vin").read(this.getView().getElementBinding("vin").getPath(),{success:$.proxy(this._readVehicleSucceed,this)})}else{this.getView().setBusy(false)}this.checkKms();this.checkPWA()},_readVehicleSucceed:function(e){this._setMileage(e)},_setMileage:function(e){var t=this._findElementIn("idKms",this._wizard.findElements(true));if(t){t.data("minKms",e.Mileage?Number(parseFloat(e.Mileage).toFixed(0)):0);t.setText("Kms > "+t.data().minKms)}this._findElementIn("idPrtKms",this._wizard.findElements(true)).setDescription("Kms <= Mileage");this.getView().setBusy(false)},initializeNewClaimData:function(){var e=this.myComponent;this.getModel("newClaim").setData({Detail:{ClaimType:this._partsClaim?"ZZPC":e.getMySettingValue("DP_CLAIMTYPE")||"0001",PWACategory:"ZZGW",PartnerNr:e.getMySettingValue("DP_KUNNR"),Plant:e.getMySettingValue("WRK"),ReferenceDate:null,VIN:null,ReferenceNr:"",ClaimSubmissionDate:new Date,SymptomCode:null,TroubleCode:null,DiagnosisTroubleCode:"",LocationGridCode:"",Mileage:null,MileageUOM:"KM",PartsInvNo:null,PartsInvoiceDate:null,PartsFittedMlg:""},ViewData:{partsClaim:false,vin:"",matnr:""}});var t=this.getModel("newClaim");if(this.isPartsClaim()){t.setProperty("/ViewData/partsClaim",true)}},_getClaimTypes:function(){var e=sap.ui.getCore().byId("claimType");if(!e)return;var t=[];if(this._partsClaim){e.bindItems({path:"/WtyClaimTypes",template:new a({key:"{ClaimType}",text:"{ClaimTypeDesc}"}),filters:new r({filters:[new r("ClaimType",s.EQ,"ZZPC")],and:true})})}else{if(this._vehiclePath){this.refreshClaimType()}}},wizardCompletedHandler:function(e){var t="",i=!!this.getView().$().closest(".sapUiSizeCompact").length;if(!this.canISave()){var a="";if(this._oStep1Validated===false)a="first";else if(this._oStep1Validated===false)a="second";else if(this._oStep1Validated===false)a="third";t="Some fields are wrong or missing. Check "+a+" step before creating!";o.error(t,{actions:[sap.m.MessageBox.Action.CLOSE],styleClass:i?"sapUiSizeCompact":""});return}var r="";if(this.getView().getBindingContext("vin")&&this.getView().getBindingContext("vin").getObject()){r=this.getView().getBindingContext("vin").getObject().VIN}var s=this.getView().getModel("newClaim").getData().Detail;if(s.Mileage===""||s.Mileage==="0"){t="Error with Mileage occurred while creating Claim./n Please click Restart and input values again./n Thank you!";o.error(t,{actions:[sap.m.MessageBox.Action.CLOSE],styleClass:i?"sapUiSizeCompact":""});return}var n=new Date(s.ClaimSubmissionDate.setHours(12));n.setMinutes(0);n.setSeconds(0);var l=new Date(s.ReferenceDate.setHours(12));var g=this.convertDateToStr(l);var d={ClaimType:s.ClaimType,PWACategory:s.ClaimType==="ZAUT"?s.PWACategory:"",PartnerNr:s.PartnerNr,Plant:s.Plant,ReferenceDate:l,ReferenceDateString:g,VIN:r,ReferenceNr:s.ReferenceNr,Mileage:s.ClaimType!=="ZZPC"?s.Mileage:"",MileageUOM:s.MileageUOM,SymptomCode:s.SymptomCode,TroubleCode:s.TroubleCode,PartsInvoiceDate:s.PartsInvoiceDate?new Date(s.PartsInvoiceDate.setHours(12)):null,ClaimSubmissionDate:n,LocationGridCode:s.LocationGridCode,DiagnosisTroubleCode:s.DiagnosisTroubleCode,PartsInvNo:this.isPartsClaim()?s.PartsInvNo:"",PartsFittedMlg:this.isPartsClaim()&&s.ClaimType!=="ZZPC"?s.PartsFittedMlg:""};this.createClaim(d)},canISave:function(){var e=this.getView().getModel("newClaim").getData().Detail;if(e.ClaimType==="ZZPC")this._oStep3Validated=true;if(this._oStep1Validated===true&&this._oStep2Validated===true&&this._oStep3Validated===true)return true;else return false},onStepActivate:function(e){var t=e.getParameter("index");var i=this.getModel("newClaim").getProperty("/Detail/ClaimType");switch(t){case 1:if(this.onStep1FieldChange){this.onStep1FieldChange(e)}break;case 2:this._wizard.getSteps()[1].setNextStep(i==="ZZPC"?"claimStep4":"claimStep3");if(this.onStep2FieldChange){this.onStep2FieldChange(e)}break;case 3:if(this.onStep3FieldChange){this.onStep3FieldChange(e)}break;default:break}},_updateSelectionTexts:function(){var e=this.getView().getModel("newClaim").getProperty("/Detail");var t="/WtySymptomCodes('"+e.SymptomCode+"')/SymptomCodeName";e.SymptomCodeDesc=this.getView().getModel().getProperty(t);e.ClaimTypeDesc=this._findElementIn("claimType",this._wizard.findElements(true)).getSelectedItem().getProperty("text");t="/WtyTroubleCodes('"+e.TroubleCode+"')/TroubleCodeName";e.TroubleCodeDesc=this.getView().getModel().getProperty(t);t="/Dealers('"+e.PartnerNr+"')/Name";e.PartnerName=this.getModel("core").getProperty(t);if(this.getView().getBindingContext()){var i=this.getView().getBindingContext().getObject();if(i.MaterialNr){this.getView().getModel("newClaim").setProperty("/ViewData/matnr",i.MaterialNr)}}if(this.getView().getBindingContext("vin")){var a=this.getView().getBindingContext("vin").getObject();if(a.VIN){this.getView().getModel("newClaim").setProperty("/ViewData/vin",a.VIN)}}},isValidDate:function(e){if(e===null){return"Error"}return e>(new Date).setHours(12)?"Error":"None"},isPartsClaim:function(e){var t=this.getView().getModel("newClaim").getData().Detail;return t.ClaimType==="ZZPC"||t.ClaimType==="ZZPW"},isNotPartsClaim:function(e){return!this.isPartsClaim(e)},onClaimTypeChange:function(e){var t=this.getView().getModel("newClaim").getData().Detail;var i="/UserSettings(UserId='"+this.myComponent.getMyId()+"',Name='DP_CLAIMTYPE')";this.getModel("core").update(i,{Value:t.ClaimType},{merge:true});var a=sap.ui.getCore().byId("pwaCategory");a.setSelectedKey("");a.setValueState("Error");this.getPWACategories(this.VIN,t.ClaimType);this.getModel("newClaim").setProperty("/ViewData/partsClaim",this.isPartsClaim())},getPWACategories:function(e,t){if(t==="ZAUT"){this.getModel().callFunction("/GetPWACategories",{method:"GET",urlParameters:{ClaimType:t,VIN:e},success:this._PWACategoriesReceived.bind(this),error:$.proxy(function(e){o.alert(this.gatewayError(e))},this)})}},_PWACategoriesReceived:function(e){var t=new sap.ui.model.json.JSONModel(e.results);var i=sap.ui.getCore().byId("pwaCategory");var a=new sap.ui.core.Item({key:"{PWACategory}",text:"{PWACategoryDesc}"});i.setModel(t);i.bindItems({path:"/",template:a})},onDealerChange:function(e){var t=this.getView().getModel("newClaim").getData().Detail;var i="/UserSettings(UserId='"+this.myComponent.getMyId()+"',Name='DP_KUNNR')";this.getModel("core").update(i,{Value:t.PartnerNr},{merge:true});this.onStep1FieldChange(e)},onRefDateChange:function(e){this.checkWarrantyValidity(e)},onMileageChange:function(e){this.checkWarrantyValidity(e)},checkKms:function(e){var t=true;var i=this.getModel("newClaim").getProperty("/Detail/ClaimType");if(i==="ZZPC")return true;var a=sap.ui.getCore().byId("idKmsInput");var r=a.getValue();sap.ui.getCore().byId("idKmsInput").setValue(parseInt(r));if(isNaN(r)||Number(r)!==Number(parseInt(r))||Number(parseInt(r))<=Number(this.getView().getBindingContext("vin").getObject().Mileage)){t=false}if(t){a.setValueState("None")}else{a.setValueState("Error");a.setValueStateText(this.getText("wtyKmsError"))}return t},checkPWA:function(){var e=true;var t=sap.ui.getCore().byId("claimType");if(t.getSelectedKey()==="ZAUT"){var i=sap.ui.getCore().byId("pwaCategory");var a=i.getSelectedKey();if(i.getItems().length>0){if(a==="")e=false}else e=false;if(e)i.setValueState("None");else{i.setValueState("Error");i.setValueStateText(this.getText("wtyPWACategoryError"))}}if(e)this.getModel("newClaim").setProperty("/Detail/PWACategory",sap.ui.getCore().byId("pwaCategory").getSelectedKey());return e},onPWACategoryChange:function(){this.checkPWA();this.onStep1FieldChange()},PWASelectState:function(e){if(e===""){return"Error"}return"None"},checkPartsFields:function(e){var t=true;if(this.isPartsClaim()){var i=this._findElementIn("idPrtInv",this._wizard.findElements(true));if(i.getValue().length>0){i.setValueState("None")}else{i.setValueState("Error");t=false}var a=this._findElementIn("idPrtInvDate",this._wizard.findElements(true));if(a.getDateValue()&&a.getDateValue()<this.getModel("newClaim").getProperty("/Detail/ReferenceDate")){a.setValueState("None")}else{a.setValueState("Error");var r=this._findElementIn("idDataLabel",this._wizard.findElements(true));r.setText(" < "+this.getModel("newClaim").getProperty("/Detail/ReferenceDate").toDateString());t=false}if(this.getModel("newClaim").getProperty("/Detail/ClaimType")!=="ZZPC"){var s=this._findElementIn("idKmsInput",this._wizard.findElements(true));var n=this._findElementIn("idPrtKms",this._wizard.findElements(true));var l=s.getValue();var o=n.getValue();if(isNaN(o)||Number(o)!==Number(parseFloat(o).toFixed(0))||Number(parseFloat(o).toFixed(0))>Number(parseFloat(l).toFixed(0))){n.setValueState("Error");t=false}else{n.setValueState("None")}}}return t},onStep1FieldChange:function(e){var t=this.checkKms(e)&&this.checkPartsFields(e)&&this.checkRepairDate(e)&&this.checkPWA()&&this.bWarrantyValid;if(this._Customer==="Inchcape"){var i=this.getView().getModel("newClaim").getProperty("/Detail");if(i.ReferenceDate>(new Date).setHours(12)){t=false}if(i.ClaimType!=="ZAUT"&&(!i.ReferenceNr||!i.ReferenceNr.length)){t=false}if(i.Milage===""||i.Milage==="0"){t=false}if(i.ClaimType==="ZAUT"){if(i.PWACategory==="")t=false}var a=this._wizard.getSteps()[0];if(t){this._wizard.validateStep(a);this._oStep1Validated=true}else{this._wizard.invalidateStep(a);this._oStep1Validated=false}this._updateSelectionTexts()}else{this.getView().byId("onSaveButton").setEnabled(t&&this._readyToCreate())}},checkRepairDate:function(e){var t=sap.ui.getCore().byId("idDatePick");if(t.getValue()===""){return false}return true},checkWarrantyValidity:function(e){var t=this.getModel("newClaim").getData().Detail;var i="";if(t.ClaimType!=="ZZPC")i=this.getView().getBindingContext("vin").getObject().VIN;var a=t.ClaimType;if(t.ReferenceDate===null){return}var r=new Date(t.ReferenceDate.setHours(12));var s=this;this.bWarrantyValid=false;this.onStep1FieldChange(e);if(t.Mileage===null){t.Mileage=0}this.getModel().callFunction("/CheckWarrantyValidity",{method:"GET",urlParameters:{VIN:i,ClaimType:a,RepairDate:r,RepairDateStr:this.convertDateToStr(r),Mileage:t.Mileage},success:$.proxy(function(t,i){if(t.NotValid==="X"){s.bWarrantyValid=false;var a=r.toLocaleDateString();var n=a+" or Mileage.";s.popErrorMessage(s.getText("wtyValidityErrorTitle"),s.getText("wtyWarrantyValidityError",[t.GaartTxt,n]))}else{s.bWarrantyValid=true;s.resetMessagePopover()}s.onStep1FieldChange(e)}),error:$.proxy(function(t){o.alert(this.gatewayError(t));s.bWarrantyValid=false;s.onStep1FieldChange(e)},this)})},refNoValueState:function(e,t){return e!=="ZAUT"&&t===""?"Error":"None"},_readyToCreate:function(){var e=this.getView().getModel("newClaim").getData().Detail;if(this._Customer!=="Inchcape"&&e&&e.Mileage&&e.Mileage>0&&e.ClaimType!==""&&e.PartnerNr!==""&&e.Plant!==""&&e.ReferenceDate<=(new Date).setHours(12)&&e.ReferenceNr!==""){return true}else{return false}},codesDownloaded:function(e){var t="stringdsad"},onStep2FieldChange:function(e){if(this._Customer!=="Inchcape")return;if($.inArray(e.getSource().getId(),["symptomCategory","troubleCategory"])>-1){this._handleSymTrbCategory(e.getSource())}else if(e.getSource().getId()==="troubleCode"){this._handleTrbCode(e.getSource())}else if(e.getSource().getId()==="symptomCode"){this._handleSympCode(e.getSource())}var t=true;var i=this.getView().getModel("newClaim").getProperty("/Detail");if(i.PartsInvoiceDate>new Date){t=false}if(i.ClaimSubmissionDate>new Date){t=false}if(!sap.ui.getCore().byId("symptomCode").getSelectedKey()||!sap.ui.getCore().byId("troubleCode").getSelectedKey()){t=false}var a=this._wizard.getSteps()[1];if(t){this._wizard.validateStep(a);this._oStep2Validated=true}else{this._wizard.invalidateStep(a);this._oStep2Validated=false}this._updateSelectionTexts()},onStep3FieldChange:function(e){var t=this.getView().getModel("newClaim").getProperty("/Detail/ClaimType");if(this._Customer!=="Inchcape")return;if(t==="ZZPC")return;var i=true;var a=this.getView().getModel("newClaim").getProperty("/Detail");var r=this._wizard.getSteps()[2];if(i){this._wizard.validateStep(r);this._oStep3Validated=true}else{this._wizard.invalidateStep(r);this._oStep3Validated=false}this._updateSelectionTexts()},discardProgress:function(e){var t=this._findElementIn("claimStep1",this.getView().byId("createClaimPage").findElements(true));this._wizard.discardProgress(t)},createClaim:function(e){var t={};if(this._partsClaim){t.causalPart=this.getView().getBindingContext().getObject().MaterialNr}this.busyDialog.open();this.getView().getModel().create("/WtyHeaders",e,{success:jQuery.proxy(function(e){this.busyDialog.close();this.initializeNewClaimData();this._wizard.destroy();this.myRouter.navTo("wtydetail",{wtyPath:"WtyHeaders(guid'"+e.GUID+"')",params:t},true);this.MessageToast.show(this.getText("wtyClaimCreated",[e.ClaimNr]))},this),error:jQuery.proxy(function(e){this.busyDialog.close();this.gatewayError(e)},this)})},onSave:function(e){this.busyDialog.open();var t=this.getView().getModel("newClaim").getData().Detail;var i={ClaimType:t.ClaimType,PartnerNr:t.PartnerNr,Plant:t.Plant,ReferenceDate:t.ReferenceDate.setHours(12),VIN:this.getView().getBindingContext("vin").getObject().VIN,ReferenceNr:t.ReferenceNr,Mileage:t.Mileage,MileageUOM:t.MileageUOM};this.createClaim(i)},onCancel:function(e){var t=this.VIN,i=sap.ushell.Container.getService("CrossApplicationNavigation"),a=i&&i.hrefForExternal({target:{semanticObject:"ZDPVehicles",action:"display"},params:{vin:t}})||"";i.toExternal({target:{shellHash:a}})},onNavBack:function(){this._wizard.destroy();this.resetMessagePopover();if(this._partsClaim){this.myRouter.navTo("partsdetail",{materialPath:"Materials('"+this.getView().getBindingContext().getProperty("MaterialNr")+"')"},true)}else{this.myRouter.navTo("vindetail",{vehiclePath:this.getView().getBindingContext("vin").getProperty("VIN")},true)}},onClaimTypeRefresh:function(e){this.refreshClaimType()},refreshClaimType:function(){var e=new sap.ui.model.json.JSONModel;var t=this;var i=this.VIN;var r=jQuery.ajax({type:"GET",contentType:"application/json",url:"/sap/opu/odata/sap/Y_DP_VEHICLE_SRV/"+this._vehiclePath+"/ClaimTypes",dataType:"json",success:function(r,s,n){var l=r.d.results,o=l;for(var g=0;g<l.length;g++){var d=l[g].ClaimType;if(d=="ZZEX")o.splice(g,1)}e.setData(o);var h=sap.ui.getCore().byId("claimType");h.setModel(e);h.bindItems({path:"/",template:new a({key:"{ClaimType}",text:"{ClaimTypeDesc}"})});if(o[0]!==undefined){t.getPWACategories(i,o[0].ClaimType)}},error:function(e,i,a){o.error(t.getText("msgErrorClmty"),{actions:[sap.m.MessageBox.Action.CLOSE]})}})},convertDateToStr:function(e){var t=e.getDate().toString().length==1?"0"+e.getDate().toString():e.getDate().toString();var i=(e.getMonth()+1).toString().length==1?"0"+(e.getMonth()+1).toString():(e.getMonth()+1).toString();return e.getFullYear().toString()+i+t}})});
//# sourceMappingURL=Create.controller.js.map