sap.ui.define(["hicron/dp/wty/controller/BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/ui/model/json/JSONModel","hicron/dp/wty/model/formatter","sap/ui/export/Spreadsheet"],function(e,t,r,a,i,n,s){"use strict";return e.extend("hicron.dp.wty.controller.Enquiry",{formatter:n,_userAuthorisations:["WarrantyClaims"],_userParameters:[],onInit:function(){e.prototype.onInit.apply(this,arguments);this.setModel(new i({facetFilterVis:false}),"viewModel");this.myRouter.getRoute("wty").attachPatternMatched(this._onWtyMatched,this);this.myRouter.getRoute("pwa").attachPatternMatched(this._onPwaMatched,this)},onAfterViewRendered:function(t){e.prototype.onAfterViewRendered.apply(this,arguments);window.document.title="Claim Search"},_onWtyMatched:function(e){var t=this.getOwnerComponent().getComponentData().startupParameters;if(t.createwtypart&&t.createwtypart[0]){this.getRouter().navTo("createwtypart",{partPath:t.createwtypart[0]},true)}else if(t.createwty&&t.createwty[0]){this.myRouter.navTo("createwty",{vehiclePath:t.createwty[0]},true)}else if(t.wtydetail&&t.wtydetail[0]){this.myRouter.navTo("wtydetail",{wtyPath:"WtyHeaders(guid'"+t.wtydetail[0]+"')"},true)}else{this._pwa=false;this.myView.byId("wtyListToolbarTitle").setText(this.getText("wtyListTitle"));var r=this.byId("wtySearchBar").getDateRange();this._performSearch(r.first,r.last)}},_onPwaMatched:function(e){this._pwa=true;this.myView.getContent()[0].setTitle(this.getText("pwaEnquiryTitle"));this.myView.byId("wtyListToolbarTitle").setText(this.getText("pwaListTitle"));var t=this.byId("wtySearchBar").getDateRange();this._performSearch(t.first,t.last)},onSearchFilter:function(e){var t=e.getParameter("filter");this._valueInputSearch=t;var r=this.byId("wtySearchBar").getDateRange();this._performSearch(r.first,r.last,t)},handleConfirmFilter:function(e){var t=e.getSource();this._filterModel(t)},_filterModel:function(e){var r=e.getLists().filter(function(e){return e.getSelectedItems().length});if(r.length){var a=new t(r.map(function(e){return new t(e.getSelectedItems().map(function(e){return new t("ProcessingStatus","EQ",e.getKey())}),false)}),true);this._applyFilter(a)}else{this._applyFilter([])}},_applyFilter:function(e){var t=this.byId("wtySearchBar").getDateRange();this._oFilter=e;this._performSearch(t.first,t.last,this._valueInputSearch)},handleFacetFilterReset:function(e){var t=sap.ui.getCore().byId(e.getParameter("id"));var r=this.getModel("viewModel").getProperty("/facetFilterVis");if(r){this.getModel("viewModel").setProperty("/facetFilterVis",false)}var a=t.getLists();for(var i=0;i<a.length;i++){a[i].setSelectedKeys()}this.getModel("viewModel").setProperty("/facetFilterVis",r);this._applyFilter()},onSearchSearch:function(e){var t=this.byId("wtySearchBar").getDateRange();this.getView().byId("idFacetFilterWty").fireReset();this._performSearch(t.first,t.last)},_createRealDate:function(e){var t=e;var r=t.getDate().toString().length==1?"0"+t.getDate().toString():t.getDate().toString();var a=(t.getMonth()+1).toString().length==1?"0"+(t.getMonth()+1).toString():(t.getMonth()+1).toString();var i=t.getFullYear().toString()+a+r;return i},_performSearch:function(e,i,n){var s=new Date(e.setHours(12));s.setMinutes(0);s.setSeconds(0);var o=new Date(i.setHours(12));o.setMinutes(0);o.setSeconds(0);var l=this._createRealDate(e);var h=this._createRealDate(i);n=n||"";var u=this.myView.byId("wtyTable");if(!u)return;var p=[new t("CreatedDte",r.BT,s,o)];p.push(new t("CreatedDteStr",r.BT,l,h));if(this._pwa){p.push(new t("ClaimType",r.EQ,"ZAUT"));p.push(new t([new t("ProcessingStatus",r.EQ,"B001"),new t("ProcessingStatus",r.EQ,"B005"),new t("ProcessingStatus",r.EQ,"B006"),new t("ProcessingStatus",r.EQ,"B061"),new t("ProcessingStatus",r.EQ,"ZRTN"),new t("ProcessingStatus",r.EQ,"ZRTR")],false))}else{}if(this._oFilter!==undefined){if(this._oFilter.aFilters!==undefined){for(var c=0;c<this._oFilter.aFilters.length;c++){p.push(this._oFilter.aFilters[c])}}}if(n.length>0){p.push(new t([new t("ClaimNr",r.Contains,n.toUpperCase()),new t("WtyHeaderText",r.Contains,n.toUpperCase()),new t([new t("ReferenceNr",r.Contains,n),new t("ReferenceNr",r.Contains,n.toUpperCase()),new t("ReferenceNr",r.Contains,n.toLowerCase())]),new t("VIN",r.Contains,n)],false))}var d=this;u.bindRows({path:"/WtyHeaders",events:{},sorter:new a("ProcessingStatus",true),filters:new t({filters:p,and:true})})},onFacetFilterUpdateFinished:function(e){if(e.getSource().getItems().length>0){this.getModel("viewModel").setProperty("/facetFilterVis",true)}},onItemPress:function(e){var t=e.getSource().getBindingContext().getObject();if(t){if(!this._oMaterialPopover){this._oMaterialPopover=sap.ui.xmlfragment("hicron.dp.wty.view.MaterialPopover",this);this.myView.addDependent(this._oMaterialPopover)}this._oMaterialPopover.bindElement("/Materials('"+t.Material+"')");this._oMaterialPopover.openBy(e.getSource())}},onPress:function(e){this.myRouter.navTo("wtydetail",{wtyPath:e.getSource().getParent().getBindingContext().getPath().substr(1)})},ListRefresh:function(){var e=this.getView().getModel();e.refresh(true)},onExport:function(){var e,t,r,a,i;i=this.byId("wtyTable");t=i.getBinding();e=this.createColumnConfig();var n=i.getModel();var o=n.getInterface();r={workbook:{columns:e,hierarchyLevel:"Level"},dataSource:{type:"odata",dataUrl:t.getDownloadUrl?t.getDownloadUrl():null,serviceUrl:o.sServiceUrl,headers:o.getHeaders?o.getHeaders():null,count:t.getLength?t.getLength():null,useBatch:o.bUseBatch,sizeLimit:o.iSizeLimit},worker:true};a=new s(r);a.build().finally(function(){a.destroy()})},createColumnConfig:function(){var e=[];e.push({label:"Number of Warranty Claim",property:"ClaimNr",type:"string"});e.push({label:"Status",property:["ProcessingStatus","ProcessingStatusText"],type:"string",template:"{0}-{1}"});e.push({label:"VIN",property:"MaterialAndSerial",type:"string"});e.push({label:"Dealer Number",property:"PartnerName",type:"string"});e.push({label:"Dealer RO Number",property:"ReferenceNr",type:"string"});e.push({label:"Repair Date",property:"ReferenceDate",type:"date"});e.push({label:"Amount Claimed",property:"ValueIC",type:"number",scale:2,delimiter:true});e.push({label:"Amount Approved",property:"ValueOC",type:"number",scale:2,delimiter:true});return e}})});
//# sourceMappingURL=Enquiry.controller.js.map